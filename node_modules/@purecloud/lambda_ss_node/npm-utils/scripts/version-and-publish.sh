#!/bin/sh

set -e

echo -e "\n======Checking Version=====\n"
NODE_PACKAGE_NAME="$(node -p "require('./package.json').name")"
NODE_PACKAGE_VERSION="$(node -p "require('./package.json').version")"
echo "  package.json version for ${NODE_PACKAGE_NAME}: ${NODE_PACKAGE_VERSION}"

# npm view <version> will return an empty string if the version doesn't exist,
# in which case we don't need to bump the patch version
if [ -n "$(npm view $NODE_PACKAGE_NAME@$NODE_PACKAGE_VERSION)" ]
then
  # bump the patch version so that we can successfully publish
  echo "  ${NODE_PACKAGE_VERSION} already published. Bumping patch version."
  npm version patch -m "Bumping patch to %s. BUILD:${BUILD_NUMBER}"
  NODE_PACKAGE_VERSION="$(node -p "require('./package.json').version")"
else
  echo "  Version not yet published. No need to bump version."
fi

echo -e "\n=====Publishing $NODE_PACKAGE_NAME@$NODE_PACKAGE_VERSION=====\n"

npm publish

echo "  published:$NODE_PACKAGE_NAME@$NODE_PACKAGE_VERSION"
