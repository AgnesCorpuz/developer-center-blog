# usage: ./jenkins-pre-build.sh node_ver [-m]
# options
#   name_ver: version of node to use
#   -m: adds the raw registry section to the npmrc for using artifactory mirror of npmjs.org

if [ -z $JENKINS_HOME ]
  then
  echo "ERROR: build script should only be run on Jenkins"
  exit 1
fi

NODE_VER=$1

USE_MIRROR=$2

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

python /private/inindca/genCurlCreds.py -s /var/build/settings.xml -o ${WORKSPACE} -r inin-yum-vagrant

artifactory_user=$(cat ${WORKSPACE}/curlCreds.conf | sed "s/-u \([a-zA-Z0-9]*\):.*/\1/")
artifactory_password=$(cat ${WORKSPACE}/curlCreds.conf | sed "s/-u \([a-zA-Z0-9]*\)://")

echo -e "\n=====Fetching npm repo configuration=====\n"
${DIR}/create-npmrc.sh ${artifactory_user} ${artifactory_password} ${USE_MIRROR} > .npmrc

source ${DIR}/install-node.sh ${NODE_VER}

echo -e "\n=====Jenkins pre-build complete=====\n"
