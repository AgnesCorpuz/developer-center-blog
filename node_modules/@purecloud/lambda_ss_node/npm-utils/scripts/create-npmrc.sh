#!/usr/bin/env bash

# usage: ./create-npmrc.sh username password [-m]
# options
#   username: artifactory username
#   password: artifactory password
#   -m: adds the raw registry section to the npmrc for using artifactory mirror of npmjs.org

username=${1}
password=${2}
USE_MIRROR=${3}

if [ -z "$username" -o -z "$password" ]; then
    printf "Please supply artifactory credentials.\nExample usage:\n  create-npmrc.sh <artifactory-username> <artifactory-password> > .npmrc\n"
    exit 1
fi

# Fetch auth config for inin's npm composite repository and make it the default repo.
# (this is where npm should install to).
MIRRORCONFIG=$(curl -f -u${username}:${password} "https://purecloud.artifactoryonline.com/purecloud/api/npm/inin-internal-npm/auth/jabbajabba" | sed "s/@jabbajabba://" | sed "/email=DevOps-CloudApplications@inin.com/d")
# Fetch auth config for inin's private npm repository.
# (this is where private packages should be published)
ININCONFIG="$(curl -f -u${username}:${password} 'https://purecloud.artifactoryonline.com/purecloud/api/npm/inin-internal-npm-dev/auth/inin-dev')"
PURECLOUDCONFIG="$(curl -f -u${username}:${password} 'https://purecloud.artifactoryonline.com/purecloud/api/npm/inin-internal-npm-dev/auth/purecloud')"

if [ "$USE_MIRROR" = "-m" ]; then
    printf "$MIRRORCONFIG\n"
fi
printf "$ININCONFIG\n$PURECLOUDCONFIG\n"
